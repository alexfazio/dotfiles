# =============================================================================
# PORTABLE ZSHRC - Base configuration for all machines
# =============================================================================
# This file is used as the default on machines without a hostname-specific
# alternate. It contains only portable, defensive configurations.
#
# Machine-specific configs should use: .zshrc##hostname.<hostname>
# =============================================================================

# -----------------------------------------------------------------------------
# PATH CONFIGURATION
# -----------------------------------------------------------------------------

# Homebrew (works on both Intel and Apple Silicon Macs)
if [[ -d /opt/homebrew ]]; then
    export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:$PATH"
elif [[ -d /usr/local/Homebrew ]]; then
    export PATH="/usr/local/bin:$PATH"
fi

# User local binaries
export PATH="$HOME/.local/bin:$PATH"

# Go (if installed)
[[ -d "$HOME/.local/opt/go/bin" ]] && export PATH="$PATH:$HOME/.local/opt/go/bin"
[[ -d "$HOME/go/bin" ]] && export PATH="$PATH:$HOME/go/bin"

# -----------------------------------------------------------------------------
# VI MODE
# -----------------------------------------------------------------------------

# Enable vi mode
bindkey -v

# Reduce ESC delay for responsive vi mode (0.1s instead of 0.4s default)
export KEYTIMEOUT=10

# Keep useful emacs-style keybindings in INSERT mode
bindkey -M viins '^R' history-incremental-search-backward  # Ctrl+R for history
bindkey -M viins '^A' beginning-of-line                    # Ctrl+A for start
bindkey -M viins '^E' end-of-line                          # Ctrl+E for end

# Alt/Option + arrow keys in INSERT mode
bindkey -M viins '^[[1;3D' backward-word     # Option + Left
bindkey -M viins '^[[1;3C' forward-word      # Option + Right

# -----------------------------------------------------------------------------
# EDITOR
# -----------------------------------------------------------------------------

# Editor fallback chain: nvim > vim > vi
if command -v nvim &>/dev/null; then
    export EDITOR="nvim"
    export VISUAL="nvim"
elif command -v vim &>/dev/null; then
    export EDITOR="vim"
    export VISUAL="vim"
else
    export EDITOR="vi"
    export VISUAL="vi"
fi

# -----------------------------------------------------------------------------
# OPTIONAL TOOLS (only load if installed)
# -----------------------------------------------------------------------------

# Rust/Cargo
[[ -f "$HOME/.cargo/env" ]] && source "$HOME/.cargo/env"

# zoxide - smarter cd command
command -v zoxide &>/dev/null && eval "$(zoxide init zsh)"

# fnm - Fast Node Manager
if [[ -d /opt/homebrew/opt/fnm/bin ]]; then
    eval "$(fnm env)"
fi

# envman
[[ -s "$HOME/.config/envman/load.sh" ]] && source "$HOME/.config/envman/load.sh"

# -----------------------------------------------------------------------------
# MACHINE-SPECIFIC AND SECRETS
# -----------------------------------------------------------------------------

# Load machine-specific overrides if exists
[[ -f ~/.zshrc.local ]] && source ~/.zshrc.local

# Load secrets (gitignored, decrypted by yadm)
[[ -f ~/.secrets.env ]] && source ~/.secrets.env

# -----------------------------------------------------------------------------
# GPG (for yadm encryption)
# -----------------------------------------------------------------------------

# Fix GPG TTY for password prompts
export GPG_TTY=$(tty)

# -----------------------------------------------------------------------------
# DOTFILES STATUS (yadm)
# -----------------------------------------------------------------------------

alias dfs="yadm status"

# -----------------------------------------------------------------------------
# DOTFILES STALE CHECK (for secondary machines)
# -----------------------------------------------------------------------------
# Checks if dotfiles are behind remote and warns on shell startup.
# Fetches in background to avoid blocking shell initialization.

_yadm_stale_check() {
    # Only run if yadm is installed
    command -v yadm &>/dev/null || return 0

    local FETCH_MARKER="$HOME/.local/share/yadm/.last-fetch"
    local FETCH_INTERVAL=3600  # 1 hour in seconds
    local NOW=$(date +%s)

    # Create marker directory if needed
    mkdir -p "$(dirname "$FETCH_MARKER")" 2>/dev/null

    # Background fetch if enough time has passed
    if [[ ! -f "$FETCH_MARKER" ]] || (( NOW - $(stat -f%m "$FETCH_MARKER" 2>/dev/null || echo 0) > FETCH_INTERVAL )); then
        # Update marker and fetch in background (non-blocking)
        touch "$FETCH_MARKER" 2>/dev/null
        (
            GIT_TERMINAL_PROMPT=0 yadm fetch origin 2>/dev/null
        ) &|
    fi

    # Check if behind (uses cached fetch data, doesn't block)
    local BEHIND=$(yadm rev-list --count HEAD..origin/main 2>/dev/null || echo 0)

    if [[ "$BEHIND" -gt 0 ]]; then
        echo "\033[33m[dotfiles] $BEHIND update(s) available. Run: yadm pull\033[0m"
    fi
}

# Run stale check on shell startup (non-blocking)
_yadm_stale_check
